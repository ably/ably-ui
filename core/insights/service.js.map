{"version":3,"sources":["../../../src/core/insights/service.ts"],"sourcesContent":["import type {\n  AnalyticsService,\n  InsightsConfig,\n  InsightsIdentity,\n  TrackPageViewOptions,\n} from \"./types\";\nimport * as datalayer from \"./datalayer\";\nimport * as mixpanel from \"./mixpanel\";\nimport * as posthog from \"./posthog\";\nimport * as logger from \"./logger\";\n\n// The real implementation that will be used after initialization\nexport class InsightsService implements AnalyticsService {\n  private debugMode: boolean = false;\n\n  initInsights({\n    mixpanelToken,\n    mixpanelAutoCapture,\n    mixpanelRecordSessionsPercent = 1,\n    posthogApiKey,\n    posthogApiHost,\n    debug = false,\n  }: InsightsConfig): void {\n    this.debugMode = !!debug;\n\n    if (this.debugMode) {\n      logger.debug(\"InsightService: Initializing insights\");\n    }\n\n    try {\n      mixpanel.initMixpanel(\n        mixpanelToken,\n        mixpanelAutoCapture,\n        this.debugMode,\n        mixpanelRecordSessionsPercent,\n      );\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to initialize Mixpanel\", e);\n      }\n    }\n\n    try {\n      posthog.initPosthog(posthogApiKey, posthogApiHost);\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to initialize Posthog\", e);\n      }\n    }\n  }\n\n  enableDebugMode(): void {\n    this.debugMode = true;\n    logger.debug(\"Enabling debug mode\");\n\n    try {\n      mixpanel.enableDebugMode();\n      posthog.enableDebugMode();\n    } catch (e) {\n      logger.error(\"Failed to enable debug mode\", e);\n    }\n  }\n\n  disableDebugMode(): void {\n    this.debugMode = false;\n    logger.debug(\"Disabling debug mode\");\n\n    try {\n      mixpanel.disableDebugMode();\n      posthog.disableDebugMode();\n    } catch (e) {\n      logger.error(\"Failed to disable debug mode\", e);\n    }\n  }\n\n  identify(identity: InsightsIdentity): void {\n    const { userId, accountId, organisationId, email, name, ...properties } =\n      identity;\n\n    // In very rare cases we might have a user without an account, so we'll\n    // let null/undefined/blank strings through on that one\n    if (!userId) {\n      if (this.debugMode) {\n        logger.warn(\"User ID not provided, skipping identify\");\n      }\n      return;\n    }\n\n    if (this.debugMode) {\n      logger.info(\"Identifying user\", {\n        userId,\n        accountId,\n        organisationId,\n        email,\n        name,\n        ...properties,\n      });\n    }\n\n    try {\n      mixpanel.identify({\n        userId,\n        accountId,\n        organisationId,\n        email,\n        name,\n        ...properties,\n      });\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to identify user in Mixpanel\", e);\n      }\n    }\n\n    try {\n      posthog.identify({\n        userId,\n        accountId,\n        organisationId,\n        email,\n        name,\n        ...properties,\n      });\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to identify user in Posthog\", e);\n      }\n    }\n  }\n\n  trackPageView(options?: TrackPageViewOptions): void {\n    const { excludeIds, includeDataLayer, ...properties } = options ?? {};\n\n    if (this.debugMode) {\n      logger.info(\"Tracking page view\");\n    }\n\n    try {\n      mixpanel.trackPageView({ excludeIds, ...properties });\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to track page view in Mixpanel\", e);\n      }\n    }\n\n    try {\n      posthog.trackPageView(properties);\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to track page view in Posthog\", e);\n      }\n    }\n\n    if (includeDataLayer) {\n      try {\n        datalayer.trackPageView(properties);\n      } catch (e) {\n        if (this.debugMode) {\n          logger.error(\"Failed to track page view in GTM\", e);\n        }\n      }\n    }\n  }\n\n  track(event: string, properties?: Record<string, unknown>): void {\n    if (this.debugMode) {\n      logger.info(\"Tracking event\", { event, properties });\n    }\n\n    try {\n      mixpanel.track(event, properties);\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to track event in Mixpanel\", e);\n      }\n    }\n\n    try {\n      posthog.track(event, properties);\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to track event in Posthog\", e);\n      }\n    }\n\n    try {\n      datalayer.track(event, properties);\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to track event in Datalayer\", e);\n      }\n    }\n  }\n\n  startSessionRecording(): void {\n    if (this.debugMode) {\n      logger.info(\"Starting session recording\");\n    }\n\n    try {\n      mixpanel.startSessionRecording();\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to start session recording in Mixpanel\", e);\n      }\n    }\n\n    try {\n      posthog.startSessionRecording();\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to start session recording in Posthog\", e);\n      }\n    }\n  }\n\n  stopSessionRecording(): void {\n    if (this.debugMode) {\n      logger.info(\"Stopping session recording\");\n    }\n\n    try {\n      mixpanel.stopSessionRecording();\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to stop session recording in Mixpanel\", e);\n      }\n    }\n\n    try {\n      posthog.stopSessionRecording();\n    } catch (e) {\n      if (this.debugMode) {\n        logger.error(\"Failed to stop session recording in Posthog\", e);\n      }\n    }\n  }\n\n  setupObserver(): () => void {\n    // Helper to get all data-insight-* attributes from an element\n    const getInsightAttributes = (\n      element: HTMLElement,\n    ): { event?: string; [key: string]: string | undefined } => {\n      // limit how many data attributes we'll process\n      const MAX_ATTRIBUTES = 10;\n      let count = 0;\n\n      const attributes: { event?: string; [key: string]: string | undefined } =\n        {};\n\n      for (const attr of Array.from(element.attributes)) {\n        if (count >= MAX_ATTRIBUTES) break;\n        if (attr.name.startsWith(\"data-insight-\")) {\n          // Validate attribute name format\n          if (!/^data-insight-[a-zA-Z0-9-]+$/.test(attr.name)) continue;\n\n          // Sanitize attribute value\n          if (typeof attr.value !== \"string\" || attr.value.length > 100)\n            continue;\n\n          // Convert data-insight-event-name to eventName\n          const key = attr.name\n            .replace(\"data-insight-\", \"\")\n            .split(\"-\")\n            .map((part: string, index: number) =>\n              index === 0 ? part : part.charAt(0).toUpperCase() + part.slice(1),\n            )\n            .join(\"\");\n          attributes[key] = attr.value;\n          count++;\n        }\n      }\n      return attributes;\n    };\n\n    // Helper to find closest element with data-insight attributes\n    const findClosestElementWithInsights = (element: HTMLElement) => {\n      let current = element;\n      while (current && current !== document.body) {\n        const insights = getInsightAttributes(current);\n        if (Object.keys(insights).length > 0) {\n          return insights;\n        }\n\n        current = current.parentElement as HTMLElement;\n      }\n      return null;\n    };\n\n    // Global click handler\n    const handleClick = (event: MouseEvent): void => {\n      if (!(event.target instanceof HTMLElement)) return;\n      const insights = findClosestElementWithInsights(event.target);\n      if (insights) {\n        // Extract special properties if they exist\n        const { event: eventName, ...properties } = insights;\n        this.track(eventName || \"element_clicked\", properties);\n      }\n    };\n\n    // Add listener to document body to catch all clicks\n    document.body.addEventListener(\"click\", handleClick);\n\n    // Return cleanup function in case it's needed\n    return () => {\n      document.body.removeEventListener(\"click\", handleClick);\n    };\n  }\n}\n"],"names":["datalayer","mixpanel","posthog","logger","InsightsService","initInsights","mixpanelToken","mixpanelAutoCapture","mixpanelRecordSessionsPercent","posthogApiKey","posthogApiHost","debug","debugMode","initMixpanel","e","error","initPosthog","enableDebugMode","disableDebugMode","identify","identity","userId","accountId","organisationId","email","name","properties","warn","info","trackPageView","options","excludeIds","includeDataLayer","track","event","startSessionRecording","stopSessionRecording","setupObserver","getInsightAttributes","element","MAX_ATTRIBUTES","count","attributes","attr","Array","from","startsWith","test","value","length","key","replace","split","map","part","index","charAt","toUpperCase","slice","join","findClosestElementWithInsights","current","document","body","insights","Object","keys","parentElement","handleClick","target","HTMLElement","eventName","addEventListener","removeEventListener"],"mappings":"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"}
{"version":3,"sources":["../../../src/core/insights/mixpanel.ts"],"sourcesContent":["import mixpanel from \"mixpanel-browser\";\n\nimport { InsightsIdentity, TrackPageViewOptions } from \"./types\";\n\nexport const initMixpanel = (\n  token: string,\n  autoCapture: boolean = false,\n  debug: boolean = false,\n  recordSessionsPercent = 1,\n) => {\n  const blockSelectors = [\"[ph-no-capture]\", '[data-sl=\"mask\"]'];\n  if (!token) {\n    console.warn(\"Mixpanel token not provided, skipping initialization\");\n    return;\n  }\n\n  mixpanel.init(token, {\n    debug: debug,\n    persistence: \"localStorage\",\n    autocapture: autoCapture\n      ? {\n          block_selectors: blockSelectors,\n          capture_text_content: true,\n          pageview: false, // We'll track page views manually\n        }\n      : false,\n    track_pageview: false, // We'll track page views manually\n    record_sessions_percent: recordSessionsPercent,\n    record_mask_text_selector: undefined, // Prevents all text from being masked - we have other masking configured/enabled\n  });\n};\n\nexport const enableDebugMode = () => {\n  mixpanel.set_config({ debug: true });\n};\n\nexport const disableDebugMode = () => {\n  mixpanel.set_config({ debug: false });\n};\n\nexport const identify = ({\n  userId,\n  accountId,\n  organisationId,\n  email,\n  name,\n  ...properties\n}: InsightsIdentity) => {\n  // In very rare cases we might have a user without an account, so we'll\n  // let null/undefined/blank strings through on that one\n  if (!userId) {\n    return;\n  }\n\n  mixpanel.identify(userId.toString());\n\n  const peopleProperties: Record<string, unknown> = { ...properties };\n\n  if (email || name) {\n    peopleProperties.$email = email;\n    peopleProperties.$name = name;\n  }\n\n  if (organisationId) {\n    peopleProperties.organization_id = [organisationId.toString()];\n  }\n\n  if (Object.keys(peopleProperties).length > 0) {\n    mixpanel.people.set(peopleProperties);\n  }\n\n  if (accountId) {\n    mixpanel.people.union({ accounts: [accountId.toString()] });\n  }\n};\n\n// Simple function to replace all digits and IDs in a URL path with {redacted},\n// purely to make reporting based on aggregates easier\nconst redactUrlSegments = (excludeIds: string[]) => {\n  const pathSegments = window.location.pathname.split(\"/\");\n\n  const redactedSegments = pathSegments.map((segment) => {\n    // Redact if the segment contains only digits or matches any of the excluded IDs\n    if (\n      /^\\d+$/.test(segment) ||\n      excludeIds.some((id) => id && id !== \"\" && segment === id)\n    ) {\n      return \"{redacted}\";\n    }\n\n    return segment;\n  });\n\n  // Join the segments back together\n  const url = new URL(window.location.href);\n  url.pathname = redactedSegments.join(\"/\");\n\n  return decodeURI(url.toString()).toLowerCase();\n};\n\nexport const trackPageView = (properties?: TrackPageViewOptions) => {\n  const { excludeIds, ...rest } = properties ?? {};\n\n  // Add the redacted URL to the page view event for reporting\n  mixpanel.track_pageview({\n    redacted_path: redactUrlSegments(excludeIds ?? []),\n    ...rest,\n  });\n};\n\nexport const track = (event: string, properties?: Record<string, unknown>) => {\n  mixpanel.track(event, properties);\n};\n\nexport const startSessionRecording = () => {\n  mixpanel.start_session_recording();\n};\n\nexport const stopSessionRecording = () => {\n  mixpanel.stop_session_recording();\n};\n"],"names":["mixpanel","initMixpanel","token","autoCapture","debug","recordSessionsPercent","blockSelectors","console","warn","init","persistence","autocapture","block_selectors","capture_text_content","pageview","track_pageview","record_sessions_percent","record_mask_text_selector","undefined","enableDebugMode","set_config","disableDebugMode","identify","userId","accountId","organisationId","email","name","properties","toString","peopleProperties","$email","$name","organization_id","Object","keys","length","people","set","union","accounts","redactUrlSegments","excludeIds","pathSegments","window","location","pathname","split","redactedSegments","map","segment","test","some","id","url","URL","href","join","decodeURI","toLowerCase","trackPageView","rest","redacted_path","track","event","startSessionRecording","start_session_recording","stopSessionRecording","stop_session_recording"],"mappings":"AAAA,OAAOA,aAAc,kBAAmB,AAIxC,QAAO,MAAMC,aAAe,CAC1BC,MACAC,YAAuB,KAAK,CAC5BC,MAAiB,KAAK,CACtBC,sBAAwB,CAAC,IAEzB,MAAMC,eAAiB,CAAC,kBAAmB,mBAAmB,CAC9D,GAAI,CAACJ,MAAO,CACVK,QAAQC,IAAI,CAAC,wDACb,MACF,CAEAR,SAASS,IAAI,CAACP,MAAO,CACnBE,MAAOA,MACPM,YAAa,eACbC,YAAaR,YACT,CACES,gBAAiBN,eACjBO,qBAAsB,KACtBC,SAAU,KACZ,EACA,MACJC,eAAgB,MAChBC,wBAAyBX,sBACzBY,0BAA2BC,SAC7B,EACF,CAAE,AAEF,QAAO,MAAMC,gBAAkB,KAC7BnB,SAASoB,UAAU,CAAC,CAAEhB,MAAO,IAAK,EACpC,CAAE,AAEF,QAAO,MAAMiB,iBAAmB,KAC9BrB,SAASoB,UAAU,CAAC,CAAEhB,MAAO,KAAM,EACrC,CAAE,AAEF,QAAO,MAAMkB,SAAW,CAAC,CACvBC,MAAM,CACNC,SAAS,CACTC,cAAc,CACdC,KAAK,CACLC,IAAI,CACJ,GAAGC,WACc,IAGjB,GAAI,CAACL,OAAQ,CACX,MACF,CAEAvB,SAASsB,QAAQ,CAACC,OAAOM,QAAQ,IAEjC,MAAMC,iBAA4C,CAAE,GAAGF,UAAU,AAAC,EAElE,GAAIF,OAASC,KAAM,CACjBG,iBAAiBC,MAAM,CAAGL,KAC1BI,CAAAA,iBAAiBE,KAAK,CAAGL,IAC3B,CAEA,GAAIF,eAAgB,CAClBK,iBAAiBG,eAAe,CAAG,CAACR,eAAeI,QAAQ,GAAG,AAChE,CAEA,GAAIK,OAAOC,IAAI,CAACL,kBAAkBM,MAAM,CAAG,EAAG,CAC5CpC,SAASqC,MAAM,CAACC,GAAG,CAACR,iBACtB,CAEA,GAAIN,UAAW,CACbxB,SAASqC,MAAM,CAACE,KAAK,CAAC,CAAEC,SAAU,CAAChB,UAAUK,QAAQ,GAAG,AAAC,EAC3D,CACF,CAAE,CAIF,MAAMY,kBAAoB,AAACC,aACzB,MAAMC,aAAeC,OAAOC,QAAQ,CAACC,QAAQ,CAACC,KAAK,CAAC,KAEpD,MAAMC,iBAAmBL,aAAaM,GAAG,CAAC,AAACC,UAEzC,GACE,QAAQC,IAAI,CAACD,UACbR,WAAWU,IAAI,CAAC,AAACC,IAAOA,IAAMA,KAAO,IAAMH,UAAYG,IACvD,CACA,MAAO,YACT,CAEA,OAAOH,OACT,GAGA,MAAMI,IAAM,IAAIC,IAAIX,OAAOC,QAAQ,CAACW,IAAI,CACxCF,CAAAA,IAAIR,QAAQ,CAAGE,iBAAiBS,IAAI,CAAC,KAErC,OAAOC,UAAUJ,IAAIzB,QAAQ,IAAI8B,WAAW,EAC9C,CAEA,QAAO,MAAMC,cAAgB,AAAChC,aAC5B,KAAM,CAAEc,UAAU,CAAE,GAAGmB,KAAM,CAAGjC,YAAc,CAAC,EAG/C5B,SAASe,cAAc,CAAC,CACtB+C,cAAerB,kBAAkBC,YAAc,EAAE,EACjD,GAAGmB,IAAI,AACT,EACF,CAAE,AAEF,QAAO,MAAME,MAAQ,CAACC,MAAepC,cACnC5B,SAAS+D,KAAK,CAACC,MAAOpC,WACxB,CAAE,AAEF,QAAO,MAAMqC,sBAAwB,KACnCjE,SAASkE,uBAAuB,EAClC,CAAE,AAEF,QAAO,MAAMC,qBAAuB,KAClCnE,SAASoE,sBAAsB,EACjC,CAAE"}
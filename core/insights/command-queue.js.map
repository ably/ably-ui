{"version":3,"sources":["../../../src/core/insights/command-queue.ts"],"sourcesContent":["import {\n  AnalyticsService,\n  Command,\n  InsightsConfig,\n  InsightsIdentity,\n  TrackPageViewOptions,\n} from \"./types\";\nimport { InsightsService } from \"./service\";\nimport * as logger from \"./logger\";\n\n// Queue handler that will collect commands before initialization\nexport class InsightsCommandQueue implements AnalyticsService {\n  private isInitialized: boolean = false;\n  private queue: Command[] = [];\n  private debugMode: boolean = false;\n  private realImplementation: InsightsService | null = null;\n\n  constructor() {\n    // Create a proxy that will either queue commands or execute them directly\n    return new Proxy(this, {\n      get: (target: InsightsCommandQueue, prop: keyof InsightsCommandQueue) => {\n        // Return actual properties of the queue\n        if (prop in target && typeof target[prop] !== \"function\") {\n          return target[prop];\n        }\n\n        // Return a function that either queues or executes the method call\n        return (...args: unknown[]) => {\n          if (!target.isInitialized || !target.realImplementation) {\n            // Queue the command for later execution\n            if (prop === \"initInsights\") {\n              // Special handling for initInsights - execute it right away\n              target.executeInitInsights(args[0] as InsightsConfig);\n              return;\n            }\n\n            // For debug logging\n            if (target.debugMode) {\n              logger.debug(`Queuing method call: ${String(prop)}`, args);\n            }\n\n            target.queue.push({\n              methodName: prop,\n              args,\n            });\n\n            return;\n          }\n\n          // Execute the command immediately on the real implementation\n          if (typeof target.realImplementation[prop] === \"function\") {\n            return (\n              target.realImplementation[prop] as (...args: unknown[]) => unknown\n            )(...args);\n          }\n        };\n      },\n    });\n  }\n\n  // Special handling for init since it needs to happen right away\n  private executeInitInsights(config: InsightsConfig): void {\n    this.debugMode = !!config.debug;\n\n    if (this.debugMode) {\n      logger.debug(\"Initializing insights\");\n    }\n\n    // Create and initialize the real implementation\n    this.realImplementation = new InsightsService();\n    this.realImplementation.initInsights(config);\n\n    // Mark as initialized and process the queue\n    this.isInitialized = true;\n    this.processQueue();\n  }\n\n  // Process all queued commands\n  private processQueue(): void {\n    if (this.debugMode) {\n      logger.debug(`Processing ${this.queue.length} queued commands`);\n    }\n\n    while (this.queue.length > 0) {\n      const cmd = this.queue.shift();\n      if (\n        cmd &&\n        this.realImplementation &&\n        typeof this.realImplementation[cmd.methodName] === \"function\"\n      ) {\n        try {\n          if (this.debugMode) {\n            logger.debug(\n              `Executing queued command: ${cmd.methodName}`,\n              cmd.args,\n            );\n          }\n\n          const fn = this.realImplementation[cmd.methodName] as (\n            ...args: unknown[]\n          ) => unknown;\n\n          // Execute the command with the real implementation\n          fn.apply(this.realImplementation, cmd.args as unknown[]);\n        } catch (e) {\n          if (this.debugMode) {\n            logger.error(\n              `Error executing queued command: ${cmd.methodName}`,\n              e,\n            );\n          }\n        }\n      }\n    }\n  }\n\n  // Implement all methods required by AnalyticsService to satisfy TypeScript\n  // (These won't be called directly due to the proxy)\n  initInsights(_config: InsightsConfig): void {}\n  enableDebugMode(): void {}\n  disableDebugMode(): void {}\n  identify(_identity: InsightsIdentity): void {}\n  trackPageView(_options?: TrackPageViewOptions): void {}\n  track(_event: string, _properties?: Record<string, unknown>): void {}\n  startSessionRecording(): void {}\n  stopSessionRecording(): void {}\n  setupObserver(): () => void {\n    return () => {};\n  }\n}\n"],"names":["InsightsService","logger","InsightsCommandQueue","executeInitInsights","config","debugMode","debug","realImplementation","initInsights","isInitialized","processQueue","queue","length","cmd","shift","methodName","args","fn","apply","e","error","_config","enableDebugMode","disableDebugMode","identify","_identity","trackPageView","_options","track","_event","_properties","startSessionRecording","stopSessionRecording","setupObserver","Proxy","get","target","prop","String","push"],"mappings":"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"}